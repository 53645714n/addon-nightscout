name: Docker build and publish

on:
    release:
      types: [published]

jobs:
  build-amd64:
    name: Build and publish amd64 image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Patch files
        uses: onlyutkarsh/patch-files-action@v1.0.1
        with:
          files: |
            nightscout/config.json
          patch-syntax: |
            = /version => "${{ github.event.release.tag_name }}"
      - name: publish amd64 docker files
        if: github.event_name != 'pull_request'
        run: docker run --rm --privileged -v /var/run/docker.sock:/var/run/docker.sock -v ~/.docker:/root/.docker -v "$(pwd)":/data homeassistant/amd64-builder	-t nightscout --amd64 --release-tag --docker-user marciogranzotto --docker-password ${{ secrets.DOCKER_PASSWORD }}
  build-armv7:
    name: Build and publish armv7 image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Patch files
        uses: onlyutkarsh/patch-files-action@v1.0.1
        with:
          files: |
            nightscout/config.json
          patch-syntax: |
            = /version => "${{ github.event.release.tag_name }}"
      - name: publish armv7 docker files
        if: github.event_name != 'pull_request'
        run: docker run --rm --privileged -v /var/run/docker.sock:/var/run/docker.sock -v ~/.docker:/root/.docker -v "$(pwd)":/data homeassistant/amd64-builder	-t nightscout --armv7 --release-tag --docker-user marciogranzotto --docker-password ${{ secrets.DOCKER_PASSWORD }}
  build-aarch64:
    name: Build and publish aarch64 image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Patch files
        uses: onlyutkarsh/patch-files-action@v1.0.1
        with:
          files: |
            nightscout/config.json
          patch-syntax: |
            = /version => "${{ github.event.release.tag_name }}"
      
      - name: publish aarch64 docker files
        if: github.event_name != 'pull_request'
        run: docker run --rm --privileged -v /var/run/docker.sock:/var/run/docker.sock -v ~/.docker:/root/.docker -v "$(pwd)":/data homeassistant/amd64-builder	-t nightscout --aarch64 --release-tag --docker-user marciogranzotto --docker-password ${{ secrets.DOCKER_PASSWORD }}
  build-i386:
    name: Build and publish i386 image
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - name: Patch files
        uses: onlyutkarsh/patch-files-action@v1.0.1
        with:
          files: |
            nightscout/config.json
          patch-syntax: |
            = /version => "${{ github.event.release.tag_name }}"
      
      - name: publish i386 docker files
        if: github.event_name != 'pull_request'
        run: docker run --rm --privileged -v /var/run/docker.sock:/var/run/docker.sock -v ~/.docker:/root/.docker -v "$(pwd)":/data homeassistant/amd64-builder	-t nightscout --i386 --release-tag --docker-user marciogranzotto --docker-password ${{ secrets.DOCKER_PASSWORD }}
  update-main-repo:
    needs: [build-amd64, build-armv7, build-aarch64, build-i386]
    name: Update addons repository
    runs-on: ubuntu-latest
    steps:
      - name: upload
        run: docker run -it --rm hassioaddons/repository-updater:latest --token ${{ secrets.GITHUB_TOKEN }} --repository marciogranzotto/addons-repository --addon nightscout